name: Port Heavy ROM (ColorOS/OriginOS) to Alioth

on:
  workflow_dispatch:
    inputs:
      BASE_ROM_URL:
        description: 'Ссылка на базовую прошивку Alioth (MIUI/HyperOS)'
        required: true
      PORT_ROM_URL:
        description: 'Ссылка на прошивку-донора (ColorOS, OriginOS, Flyme)'
        required: true
      repack_type:
        description: 'Тип файловой системы (erofs для Android 13/14, ext4 для старых)'
        required: true
        default: 'erofs'
        type: choice
        options:
        - erofs
        - ext4

jobs:
  porting:
    runs-on: ubuntu-24.04
    
    steps:
      # 1. РУЧНАЯ ОЧИСТКА МЕСТА (Без использования сторонних экшенов)
      - name: Free Disk Space (Manual)
        run: |
          echo ">>> Freeing disk space..."
          # Удаляем ненужный предустановленный софт
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          # Чистим Docker образы
          sudo docker image prune --all --force
          echo ">>> Disk space freed."

      # 2. Установка необходимых инструментов
      - name: Install Porting Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget unzip tar adb autoconf automake libtool android-sdk-libsparse-utils aria2 python3-pip e2fsprogs
          sudo apt-get install -y erofs-utils
          
          # Установка payload-dumper-go
          wget https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -xvf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          sudo mv payload-dumper-go /usr/local/bin/
          rm payload-dumper-go_1.2.2_linux_amd64.tar.gz

          # Установка magiskboot (Надежный способ: из официального APK Magisk v27.0)
          echo ">>> Downloading Magisk..."
          wget https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk
          unzip -j Magisk-v27.0.apk lib/x86_64/libmagiskboot.so
          mv libmagiskboot.so magiskboot
          chmod +x magiskboot
          sudo mv magiskboot /usr/local/bin/
          rm Magisk-v27.0.apk

          mkdir -p work/base work/port work/repack

      # 3. Скачивание и распаковка (С УДАЛЕНИЕМ АРХИВОВ)
      - name: Download & Extract
        run: |
          cd work
          
          # --- BASE ROM ---
          echo ">>> Downloading Base ROM..."
          aria2c -x16 -s16 -o base.zip "${{ github.event.inputs.BASE_ROM_URL }}"
          echo ">>> Extracting Base..."
          payload-dumper-go -o base_out base.zip || unzip base.zip -d base_out
          echo ">>> Deleting Base Zip..."
          rm -f base.zip  # УДАЛЯЕМ ZIP СРАЗУ
          
          # --- PORT ROM ---
          echo ">>> Downloading Port ROM..."
          aria2c -x16 -s16 -o port.zip "${{ github.event.inputs.PORT_ROM_URL }}"
          echo ">>> Extracting Port..."
          payload-dumper-go -o port_out port.zip || unzip port.zip -d port_out
          echo ">>> Deleting Port Zip..."
          rm -f port.zip  # УДАЛЯЕМ ZIP СРАЗУ

      # 4. Подготовка образов
      - name: Prepare Images
        run: |
          cd work
          mkdir -p mnt_point
          
          extract_image() {
            img_path=$1
            out_dir=$2
            echo "Processing $img_path..."
            if magic=$(head -c 4 "$img_path" | xxd -p) && [ "$magic" = "e2e1f5e0" ]; then
              fsck.erofs --extract="$out_dir" "$img_path"
            else
              if file "$img_path" | grep -q "Android sparse"; then
                 simg2img "$img_path" raw.img
                 mv raw.img "$img_path"
              fi
              mkdir -p "$out_dir"
              sudo mount -o ro,loop "$img_path" mnt_point
              sudo cp -a mnt_point/* "$out_dir"/
              sudo umount mnt_point
            fi
            # УДАЛЯЕМ ИСХОДНЫЙ ОБРАЗ ПОСЛЕ РАСПАКОВКИ ДЛЯ ЭКОНОМИИ МЕСТА
            rm -f "$img_path"
          }
          
          # Извлекаем основные разделы Порта
          for part in system product system_ext; do
            [ -f port_out/$part.img ] && extract_image port_out/$part.img repack/$part
          done
          
          # Копируем файлы Базы
          cp base_out/vendor.img repack/vendor.img
          cp base_out/boot.img repack/boot.img
          cp base_out/dtbo.img repack/dtbo.img || true
          [ -f base_out/odm.img ] && cp base_out/odm.img repack/odm.img
          
          # УДАЛЯЕМ ПАПКИ С РАСПАКОВАННЫМИ ИСХОДНИКАМИ
          echo ">>> Cleaning up source folders..."
          rm -rf base_out port_out

      # 5. ГЛАВНЫЙ ПАТЧИНГ
      - name: HEAVY PATCHING
        run: |
          cd work/repack
          
          echo ">>> Installing Alioth Overlay..."
          mkdir -p product/overlay
          git clone https://github.com/d0llbluesv4nus/overlayapk temp_overlay
          if ls temp_overlay/*.apk 1> /dev/null 2>&1; then
            sudo cp temp_overlay/*.apk product/overlay/
            sudo chmod 644 product/overlay/*.apk
            sudo rm -f product/overlay/*DisplayCutout*.apk
            sudo rm -f product/overlay/*RoundedCorners*.apk
            sudo rm -f product/overlay/*Notch*.apk
          fi
          rm -rf temp_overlay

          echo ">>> Patching init.rc..."
          find . -name "*.rc" -print0 | xargs -0 sudo sed -i 's/avb_keys/disabled_avb_keys/g'
          find . -name "*.rc" -print0 | xargs -0 sudo sed -i 's/dm-verity/disabled-dm-verity/g'
          
          echo ">>> Patching fstab..."
          grep -r "fstab" . || true
          find system -name "fstab*" -print0 | xargs -0 sudo sed -i 's/forceencrypt/encryptable/g'
          find system -name "fstab*" -print0 | xargs -0 sudo sed -i 's/fileencryption/encryptable/g'
          find system -name "fstab*" -print0 | xargs -0 sudo sed -i 's/avb/wa/g'
          find system -name "fstab*" -print0 | xargs -0 sudo sed -i 's/,verify//g'

          echo ">>> Debloating..."
          sudo rm -rf system/recovery-from-boot.p
          sudo rm -rf system/bin/install-recovery.sh
          
          echo ">>> Spoofing build.prop..."
          find . -name "build.prop" -print0 | xargs -0 sudo sed -i 's/ro.product.device=.*/ro.product.device=alioth/g'
          find . -name "build.prop" -print0 | xargs -0 sudo sed -i 's/ro.product.model=.*/ro.product.model=M2012K11AC/g'
          find . -name "build.prop" -print0 | xargs -0 sudo sed -i 's/ro.product.name=.*/ro.product.name=alioth/g'
          find . -name "build.prop" -print0 | xargs -0 sudo sed -i 's/ro.sf.lcd_density=.*/ro.sf.lcd_density=440/g'

      # 6. ПАТЧИНГ ЯДРА
      - name: Patch Boot Image
        run: |
          cd work/repack
          magiskboot unpack boot.img
          
          if [ -f ramdisk.cpio ]; then
            magiskboot cpio ramdisk.cpio extract
            if [ -f fstab.qcom ]; then
                sed -i 's/,verify//g' fstab.qcom
                sed -i 's/,avb//g' fstab.qcom
                sed -i 's/forceencrypt/encryptable/g' fstab.qcom
                sed -i 's/wait,check/wait,check,quota/g' fstab.qcom
            fi
            magiskboot cpio ramdisk.cpio patch
            magiskboot cpio ramdisk.cpio repack ramdisk_new.cpio
            mv ramdisk_new.cpio ramdisk.cpio
          fi
          
          magiskboot repack boot.img
          mv new-boot.img boot-patched.img
          rm -f boot.img *cpio *dtb kernel

      # 7. СБОРКА ОБРАЗОВ
      - name: Repack Images
        run: |
          cd work/repack
          
          repack_fs() {
            dir_name=$1
            out_name=$2
            type="${{ github.event.inputs.repack_type }}"
            
            echo ">>> Repacking $dir_name to $type..."
            if [ "$type" = "erofs" ]; then
               mkfs.erofs -zLZ4HC "$out_name.img" "$dir_name"
               # После упаковки удаляем папку, чтобы освободить место для следующего шага
               sudo rm -rf "$dir_name"
            else
               SIZE=$(du -sb "$dir_name" | cut -f1)
               SIZE=$((SIZE + 100000000))
               make_ext4fs -s -l $SIZE -a "$dir_name" "$out_name.img" "$dir_name"
               sudo rm -rf "$dir_name"
            fi
          }
          
          [ -d system ] && repack_fs system system
          [ -d product ] && repack_fs product product
          [ -d system_ext ] && repack_fs system_ext system_ext

      # 8. СОЗДАНИЕ ZIP
      - name: Create ZIP
        run: |
          cd work
          mkdir final_zip
          cd final_zip
          
          mv ../repack/*.img .
          mv boot-patched.img boot.img
          
          git clone https://github.com/n00b69/f3-flashable-template.git temp_tmpl
          cp -r temp_tmpl/META-INF .
          rm -rf temp_tmpl
          
          echo ">>> Zipping..."
          zip -r9 Ported_ROM_Alioth.zip .

      # 9. ЗАГРУЗКА
      - name: Upload ROM
        uses: actions/upload-artifact@v4
        with:
          name: Ported_ROM_Alioth_${{ github.run_id }}
          path: work/final_zip/Ported_ROM_Alioth.zip
